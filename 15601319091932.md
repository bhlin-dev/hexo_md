# Gitlab-CI+Fastlaneæ­å»ºä»‹ç»

æœ€è¿‘ç”±äºå·¥ä½œåŸå› éœ€è¦ç ”ç©¶æŒç»­é›†æˆï¼Œç”±äºå…¬å¸é‡‡ç”¨çš„gitlabç®¡ç†ä»£ç ï¼Œè‡ªç„¶è€Œç„¶çš„å†ç ”ç©¶CIè¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆé’ˆå¯¹gitlab-ciè¿›è¡Œç ”ç©¶ï¼Œåé¢ä¼šå¯¹jenkinsè¿›è¡Œè°ƒç ”ï¼Œå¯¹æ¯”ä¸¤è€…çš„ä¼˜åŠ£ã€‚

### ç ”ç©¶è¿‡ç¨‹ä¸­çš„ç¬¬ä¸€æ­¥ gitlab-CI

åœ¨gitlabä¸­å®ŒæˆæŒç»­é›†æˆCIåŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼š
* é…ç½®ä¸€ä¸ªRunner(ç”¨æ¥ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…)
* åœ¨é¡¹ç›®æ ¹ç›®å½•å¢å‡YAMLæ ¼å¼çš„CIè„šæœ¬æ–‡ä»¶`.gitlab-ci.yml`

#### é…ç½®Runner

ç”±äºæˆ‘ä»¬çš„é¡¹ç›®æ˜¯iOSï¼Œæ‰€ä»¥éœ€è¦åœ¨ä¸€å°å®‰è£…äº†macosæ“ä½œç³»ç»Ÿå’Œxcodeçš„ç¯å¢ƒæ‰èƒ½ç¼–è¯‘ã€æ‰“åŒ…ï¼Œå› æ­¤éœ€è¦å°†ä¸€å°macè®¡ç®—æœºé…ç½®æˆæˆ‘ä»¬çš„ä¸€ä¸ªRunnerã€‚æ‰€è°“çš„åŸºæœ¬åŸç†å°±æ˜¯ï¼Œæˆ‘ä»¬åœ¨ä¸€å°macä¸Šå®‰è£…ä¸€ä¸ªä»£ç†ç¨‹åºgitlab-ci-multi-runner,ç„¶åå°†macæ³¨å†Œåˆ°gitlabæœåŠ¡ç«¯ï¼Œç„¶åè¿™å°macå°±å¯ä»¥æ¥å—gitlabæœåŠ¡ç«¯ä¸‹å‘çš„CIä»»åŠ¡ï¼Œå®Œæˆç›¸åº”çš„ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…ç­‰å·¥ï¼Œç„¶åå°†ç»“æœåé¦ˆç»™æœåŠ¡ç«¯ã€‚

åœ¨ä¸€å°macä¸Šå®‰è£…gitlab-runner

```
sudo curl --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-darwin-amd64

sudo chmod +x /usr/local/bin/gitlab-runner
```

å®‰è£…ç»“æŸåï¼Œæ‰“å¼€gitlabï¼Œè¿›å…¥éœ€è¦æŒç»­é›†æˆçš„é¡¹ç›®ï¼Œé€‰æ‹©`è®¾ç½®`->`CI/CD`,æ‰“å¼€Runnerï¼Œå¯ä»¥çœ‹åˆ°Runnerè®¾ç½®æŒ‡å®šçš„URLå’Œtoken.![](http://47.75.49.0:8080/wp-content/uploads/2019/03/WX20190304-102144.png)

```
gitlab-runner register

#Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/ci):
#è¾“å…¥ä¸Šå›¾ä¸­çš„URL.
#Please enter the gitlab-ci token for this runner:
#ï¿½è¾“å…¥ä¸Šå›¾ä¸­çš„token.
#Please enter the gitlab-ci description for this runner:
#è¾“å…¥ä¸€ä¸ªæè¿°ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬è¾“å…¥mac_runner
#Please enter the gitlab-ci tags for this runner (comma separated):
#ï¿½è¾“å…¥ä¸€äº›æ ‡ç­¾ï¼Œè¿™é‡Œæˆ‘ä»¬è¾“å…¥"mac,xcode7.1"
# Registering runner... succeeded runner=euasz2j9 
#Please enter the executor: docker-ssh+machine, docker, docker-ssh, parallels, shell, ssh, virtualbox, docker+machine:
#è¿™é‡Œæˆ‘ä»¬è¾“å…¥shellï¼Œå› ä¸ºiosé¡¹ç›®çš„ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…æˆ‘ä»¬éƒ½é‡‡ç”¨è„šæœ¬æ¥æ‰§è¡Œã€‚
#Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded!
#æ³¨å†ŒæˆåŠŸï¼Œæ¥ä¸‹æ¥å¯åŠ¨å®ƒ
gitlab-runner install
gitlab-runner start
```

ä¸‹è½½æˆ‘ä»¬çš„æœºå™¨å°±æ³¨å†Œæˆgitlabçš„ä¸€ä¸ªRunneräº†ï¼Œé‡æ–°æ‰“å¼€è·å–urlå’Œtokençš„é¡µé¢ï¼Œå†å…¶ä¸‹é¢å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ³¨å†Œçš„Runneräº†![](http://47.75.49.0:8080/wp-content/uploads/2019/03/WX20190304-103058.png)

#### å¢åŠ CIè„šæœ¬æ–‡ä»¶.gitlab-ci.yml

åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¹Ÿå°±æ˜¯ä¸.gitéšè—æ–‡ä»¶å¤¹å¹³çº§çš„ç›®å½•åˆ›å»º*.gitlab-ci.yml*æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

![](http://47.75.49.0:8080/wp-content/uploads/2019/03/WX20190304-103212.png)

```
# å£°æ˜å˜é‡ï¼Œå…¶ä¸­ä½¿ç”¨shellè¯­è¨€çš„ç¼–ç æ–¹å¼
variables:
  FILE_PATH: "build"
  LC_ALL: "en_US.UTF-8"
  LANG: "en_US.UTF-8"

before_script:
  - gem install bundler
  - bundle install

stages:
  - build

build_project:
  stage: build
  script:
    - pod install
    - xcodebuild clean -workspace DJEncrypt.xcworkspace -scheme DJEncrypt -configuration Release
    - xcodebuild archive -workspace DJEncrypt.xcworkspace -scheme DJEncrypt -configuration Release -archivePath "$FILE_PATH/DJEncrypt.xcarchive"
    - xcodebuild  -exportArchive -archivePath "$FILE_PATH/DJEncrypt.xcarchive" -exportPath "$FILE_PATH" -exportOptionsPlist "ExportOptions/ExportOptions.plist"
    - if [ $FILE_UPLOAD == "true" ]; then echo "ä¸Šä¼ äº†"; else echo "æ²¡æœ‰ä¸Šä¼ å“¦"; fi
    - curl -F "file=@build/DJEncrypt.ipa" -F "installType=2" -F "password=123abc" -F "uKey=31f5a25aa1c05f223be0a7da7ce7cae3" -F "_api_key=6c76035bf32c650378be920fd94ad232" https://qiniu-storage.pgyer.com/apiv1/app/upload
  artifacts:
    paths:
      - $FILE_PATH/DJEncrypt.ipa
```

å…¶ä¸­ä½¿ç”¨xcodebuildè„šæœ¬ç»™appæ‰“åŒ…å’Œä¸Šä¼ è’²å…¬è‹±å¸‚åœº[è’²å…¬è‹± - APIæ–‡æ¡£](https://www.pgyer.com/doc/api#uploadApp)ã€‚è‡³äº.gitlab-ci.ymlçš„å†…å®¹ï¼Œå¯ä»¥åœ¨å®˜æ–¹æ–‡æ¡£ä¸­çœ‹åˆ°[ä½¿ç”¨.gitlab-ci.yml |é…ç½®ç®¡é“ GitLab](https://docs.gitlab.com/ee/ci/yaml/README.html)ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•æ·»åŠ å®Œ.gitlab-ci.ymlæ–‡ä»¶åï¼Œå°†è¯¥æ–‡ä»¶ä¸Šä¼ åˆ°gitlabè¿œç¨‹ä»“åº“ä¸­ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜çš„è¯ï¼ŒCIå·²ç»å¼€å§‹æ‰§è¡Œç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…äº†ã€‚
![å›¾ç‰‡](http://47.75.49.0:8080/wp-content/uploads/2019/03/WX20190304-103421.png)

åœ¨gitlabé¡¹ç›®ä¸­ï¼Œé€‰æ‹©CI/CDå¯ä»¥é€‰æ‹©æŒ‡å®šçš„åˆ†æ”¯å¼€å§‹ç”Ÿäº§ä»»åŠ¡ã€‚ä½†æ˜¯è¿™äº›åˆ†æ”¯è¦å­˜åœ¨.gitlab-ci.ymlå¹¶ä¸”è„šæœ¬ä¸­æ²¡æœ‰å¯¹å½“å‰åˆ†æ”¯åšé™åˆ¶ã€‚åœ¨åˆ›å»ºæµæ°´çº¿çš„æ—¶å€™å¯ä»¥æ ¹æ®å˜é‡åç§°åˆ›å»ºå˜é‡çš„å€¼ï¼Œè¿™é‡Œçš„ä¼˜å…ˆçº§å¤§äºè„šæœ¬ä¸­çš„ä¼˜å…ˆçº§ï¼Œä¹Ÿå°±æ˜¯è¯´åŒæ ·çš„å˜é‡ï¼Œåœ¨è¿™é‡Œèµ‹å€¼ä¼šè¦†ç›–è„šæœ¬ä¸­çš„å˜é‡ã€‚è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¾ç½®ä¸åŒçš„å˜é‡åˆ›å»ºä¸åŒçš„æµæ°´çº¿äº†ã€‚
![å›¾ç‰‡](http://47.75.49.0:8080/wp-content/uploads/2019/03/WX20190304-103600.png)

ç®€å•ä»‹ç»YAML

Stages: é˜¶æ®µ
----

.gitlab-ci.ymlä¸­å¯ä»¥åŒ…å«å¾ˆå¤šé˜¶æ®µ: å®‰è£…ä¾èµ–ã€è¿è¡Œæµ‹è¯•ã€ç¼–è¯‘ã€éƒ¨ç½²æµ‹è¯•æœåŠ¡å™¨ã€éƒ¨ç½²ç”Ÿäº§æœåŠ¡å™¨ç­‰æµç¨‹ã€‚ä½¿ç”¨stagesæ¥å®šä¹‰,å¦‚ä¸‹å®šä¹‰äº†buildå’Œtestä¸¤ä¸ªé˜¶æ®µ:

```
stages:
  - build
  - test
```

ç‰¹ç‚¹

    æ‰€æœ‰Stagesä¼šæŒ‰ç…§é¡ºåºè¿è¡Œï¼Œå³å½“ä¸€ä¸ªStageå®Œæˆåï¼Œä¸‹ä¸€ä¸ªStageæ‰ä¼šå¼€å§‹
    åªæœ‰å½“æ‰€æœ‰Stageså®Œæˆåï¼Œè¯¥æ„å»ºä»»åŠ¡æ‰ä¼šæˆåŠŸ
    å¦‚æœä»»ä½•ä¸€ä¸ªStageå¤±è´¥ï¼Œé‚£ä¹ˆåé¢çš„Stagesä¸ä¼šæ‰§è¡Œï¼Œè¯¥æ„å»ºä»»åŠ¡å¤±è´¥
    
Job: å·¥ä½œ(å·¥ä½œåå”¯ä¸€, å¹¶ä¸”ä¸èƒ½ä¸ºå…³é”®å­—)
----

Jobs è¡¨ç¤ºæ„å»ºå·¥ä½œï¼Œè¡¨ç¤ºæŸä¸ªStageé‡Œé¢æ‰§è¡Œçš„å·¥ä½œã€‚æˆ‘ä»¬å¯ä»¥åœ¨Stagesé‡Œé¢å®šä¹‰å¤šä¸ªJobs.

```
build_project:
  stage: build
  script:
    - xcodebuild clean -project ProjectName.xcodeproj -scheme SchemeName | xcpretty
    - xcodebuild test -project ProjectName.xcodeproj -scheme SchemeName -destination 'platform=iOS Simulator,name=iPhone 6s,OS=9.2' | xcpretty -s
  tags:
    - ios_9-2
    - xcode_7-2
    - osx_10-11
archive_project:
  stage: archive
  script:
    - xcodebuild clean archive -archivePath build/ProjectName -scheme SchemeName
    - xcodebuild -exportArchive -exportFormat ipa -archivePath "build/ProjectName.xcarchive" -exportPath "build/ProjectName.ipa" -exportProvisioningProfile "ProvisioningProfileName"
  only:
    - master
  artifacts:
    paths:
      - build/ProjectName.ipa
  tags:
    - ios_9-2
    - xcode_7-2
    - osx_10-11
```

| å…³é”®å­— | æ˜¯å¦å¿…é¡» | æè¿° |
| --- | --- | ---|
| script | å¿…é¡» | å®šä¹‰Runneréœ€è¦æ‰§è¡Œçš„è„šæœ¬æˆ–å‘½ä»¤ |
| image | éå¿…é¡» | éœ€è¦ä½¿ç”¨çš„dockeré•œåƒï¼Œè¯·æŸ¥é˜…è¯¥æ–‡æ¡£ |
| services | éå¿…é¡» | å®šä¹‰äº†æ‰€éœ€çš„dockeræœåŠ¡ï¼Œè¯·æŸ¥é˜…è¯¥æ–‡æ¡£ |
| stage | éå¿…é¡» | å®šä¹‰äº†å·¥ä½œçš„åœºæ™¯é˜¶æ®µ,é»˜è®¤æ˜¯test |
| type | éå¿…é¡» | stageçš„åˆ«åï¼Œä¸èµæˆä½¿ç”¨ |
| variables | éå¿…é¡» | åœ¨jobçº§åˆ«ä¸Šå®šä¹‰çš„å˜é‡ |
| only | éå¿…é¡» | å®šä¹‰å“ªäº›gitå¼•ç”¨ï¼ˆåˆ†æ”¯ï¼‰é€‚ç”¨è¯¥job |
| except | éå¿…é¡» | å®šä¹‰äº†å“ªäº›gitå¼•ç”¨(åˆ†æ”¯)ä¸é€‚ç”¨è¯¥job |
| tags | éå¿…é¡» | å®šä¹‰äº†å“ªäº›runneré€‚ç”¨è¯¥jobï¼ˆrunneråœ¨åˆ›å»ºæ—¶ä¼šè¦æ±‚ç”¨æˆ·è¾“å…¥æ ‡ç­¾åæ¥ä»£è¡¨è¯¥runnerï¼‰ |
| allow_failure | éå¿…é¡» | å…è®¸ä»»åŠ¡å¤±è´¥ï¼Œä½†æ˜¯å¦‚æœå¤±è´¥ï¼Œå°†ä¸ä¼šæ”¹å˜æäº¤çŠ¶æ€ |
| when | éå¿…é¡» | å®šä¹‰jobä»€ä¹ˆæ—¶å€™èƒ½è¢«æ‰§è¡Œï¼Œå¯ä»¥æ˜¯on_success,on_failure,alwaysæˆ–è€…manual |
| dependencies | éå¿…é¡» | å®šä¹‰äº†è¯¥jobä¾èµ–å“ªä¸€ä¸ªjobï¼Œå¦‚æœè®¾ç½®è¯¥é¡¹ï¼Œä½ å¯ä»¥é€šè¿‡artifactsè®¾ç½® |
| artifacts | éå¿…é¡» | æ‰€è°“å·¥ä»¶ã€‚ã€‚å°±æ˜¯åœ¨ä¾èµ–é¡¹ä¹‹é—´ä¼ é€’çš„ä¸œè¥¿ï¼Œç±»ä¼¼cacheï¼Œä½†åŸç†ä¸cacheä¸åŒ |
| cache | éå¿…é¡» | å®šä¹‰éœ€è¦è¢«ç¼“å­˜çš„æ–‡ä»¶ã€æ–‡ä»¶å¤¹åˆ—è¡¨ |
| before_script | éå¿…é¡» | è¦†ç›–åœ¨æ ¹å…ƒç´ ä¸Šå®šä¹‰çš„before_script |
| after_script | éå¿…é¡» | è¦†ç›–åœ¨æ ¹å…ƒç´ ä¸Šå®šä¹‰çš„after_script |
| environment | éå¿…é¡» | å®šä¹‰è®©jobå®Œæˆéƒ¨ç½²çš„ç¯å¢ƒåç§° |
| retry | éå¿…é¡» | å®šä¹‰jobå¤±è´¥åçš„è‡ªåŠ¨é‡è¯•æ¬¡æ•° |
    
ç‰¹ç‚¹

    ç›¸åŒStageä¸­çš„Jobsä¼šå¹¶è¡Œæ‰§è¡Œ
    ç›¸åŒStageä¸­çš„Jobséƒ½æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œè¯¥Stageæ‰ä¼šæˆåŠŸ
    å¦‚æœä»»ä½•ä¸€ä¸ªJobå¤±è´¥ï¼Œé‚£ä¹ˆè¯¥Stageå¤±è´¥ï¼Œå³è¯¥æ„å»ºä»»åŠ¡å¤±è´¥

#### xcodebuildå‘½ä»¤

xcodebuild å‘½ä»¤æ˜¯ Xcode Command Line Tools çš„ä¸€éƒ¨åˆ†ã€‚é€šè¿‡è°ƒç”¨è¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥å®Œæˆ iOS å·¥ç¨‹çš„ç¼–è¯‘ï¼Œæ‰“åŒ…å’Œç­¾åè¿‡ç¨‹ã€‚è¿™ä¸ªå‘½ä»¤éšç€ Xcode çš„ç‰ˆæœ¬ä¸åŒä½¿ç”¨æ–¹æ³•ä¸Šä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚æ‰“å¼€å‘½ä»¤è¡Œï¼Œè°ƒç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ä½¿ç”¨æ–¹æ³•ï¼š

```
xcodebuild --help
```

è¯­æ³•ï¼šåœ¨shellé‡Œé¢ [ ]è¡¨ç¤ºè¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œ< > è¡¨ç¤ºå‚æ•°æ˜¯å¿…é¡»çš„ã€‚

```
xcodebuild [-project projectname] [-target targetname ...] [-configuration configurationname]
            [-sdk [sdkfullpath | sdkname]] [buildaction ...] [setting=value ...]
            [-userdefault=value ...]
```

#### è®¾ç½®è§¦å‘è§’å’Œé€šè¿‡apiè§¦å‘CI

è®¾ç½®è§¦å‘è§’å¯ä»¥é€šè¿‡åœ¨YMLæ–‡ä»¶ä¸­ï¼Œä½¿ç”¨onlyè®¾ç½®è§¦å‘è§’çš„tagæˆ–è€…åç§°ã€‚

    only:
    - tags
    - triggers

é€šè¿‡postè¯·æ±‚ http://172.19.3.125/api/v4/projects/73(é¡¹ç›®ç¼–å·)/ref/triggers(è§¦å‘è§’åç§°)/trigger(åˆ†æ”¯åç§°)/pipeline
å‚æ•°ï¼štoken


### ç ”ç©¶ç¬¬äºŒæ­¥fastlane

fastlaneæ˜¯ä¸ºiOSå’ŒAndroidåº”ç”¨ç¨‹åºè‡ªåŠ¨åŒ–betaéƒ¨ç½²å’Œå‘å¸ƒçš„æœ€ç®€å•æ–¹æ³•ã€‚ğŸš€å®ƒå¤„ç†æ‰€æœ‰ç¹ççš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç”Ÿæˆå±å¹•æˆªå›¾ï¼Œå¤„ç†ä»£ç ç­¾åå’Œå‘å¸ƒåº”ç”¨ç¨‹åºã€‚

å½“ç¨å¾®ç ”ç©¶fastlaneå‘ç°ï¼Œä½¿ç”¨gitlab-ciå’Œjenkinså“ªä¸€ç§æŒç»­åŒ–é›†æˆå¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚fastlaneé’ˆå¯¹è¿™ä¸¤ç§å¹³å°éƒ½æ”¯æŒã€‚é’ˆå¯¹äºfastlaneçš„ç ”ç©¶ä¸»è¦é˜…è¯»fastlaneçš„æ–‡æ¡£[](https://docs.fastlane.tools/)

#### ä½¿ç”¨åœºæ™¯

* æäº¤æ—¶æ‰§è¡Œæµ‹è¯•ï¼ˆåŒ…æ‹¬å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼‰ã€‚
* æ„å»ºå¹¶åˆ†å‘å†…éƒ¨æµ‹è¯•ï¼Œå…¬å¼€æµ‹è¯•ç‰ˆæœ¬ã€‚
* æ„å»ºç”Ÿäº§ç‰ˆæœ¬å¹¶ä¸Šä¼ è‡³ ITCï¼ˆåŒ…æ‹¬æ›´æ–°é…ç½®æ–‡ä»¶,åˆ›å»ºæ–°çš„å±å¹•æˆªå›¾,ä¸Šä¼ åº”ç”¨å¹¶æäº¤å®¡æ ¸ï¼‰ã€‚
* â€¦


#### å·¥å…·é›†

fastlane å°†å¦‚ä¸‹çš„å·¥å…·å¥—ä»¶æœ‰æœºåœ°ç»“åˆèµ·æ¥,ä»ç®¡ç†è¯ä¹¦åˆ°å•å…ƒæµ‹è¯•,ä»ç¼–è¯‘æ‰“åŒ…åˆ°ä¸Šä¼ å‘å¸ƒ,éƒ½èƒ½é€šè¿‡å‘½ä»¤è¡Œè½»æ¾å®Œæˆ.è¯¥å¥—ä»¶æ”¯æŒä¸ Jenkins å’Œ CocoaPods,xctools ç­‰å…¶ä»–ç¬¬ä¸‰æ–¹å·¥å…·çš„é›†æˆ,å¹¶ä¸”èƒ½å¤Ÿå®šä¹‰å¤šä¸ªé€šé“ï¼ˆlanesï¼‰ä»¥æ”¯æŒä¸åŒçš„éƒ¨ç½²ç›®æ ‡ã€‚

* æµ‹è¯•å·¥å…·

    scanï¼šè‡ªåŠ¨è¿è¡Œæµ‹è¯•å·¥å…·ï¼Œå¯ä»¥ç”Ÿæˆæ¼‚äº®çš„HTMLæŠ¥å‘Šã€‚

* ç”Ÿæˆè¯ä¹¦ã€é…ç½®å·¥å…·

    certï¼šè‡ªåŠ¨åˆ›å»ºiOSä»£ç ç­¾åè¯ä¹¦(.certæ–‡ä»¶)ã€‚
    sigh: åˆ›å»ºã€æ›´æ–°ã€ä¸‹è½½å’Œä¿®å¤ provisioning profiles,æ”¯æŒApp Store, Ad Hoc, Developmentå’Œä¼ä¸šprofilesã€‚
    pemï¼šè‡ªåŠ¨ç”Ÿæˆã€æ›´æ–°æ¨é€é…ç½®æ–‡ä»¶ã€‚

* æˆªå›¾ã€ä¸Šä¼ ã€æè®¾å¤‡è¾¹æ¡†

    deliver: ä¸Šä¼ æˆªå›¾ã€å…ƒæ•°æ®ã€Appåˆ°iTunesConnectã€‚
    snapshot: ä¾é  UI Test å®Œæˆæˆªå›¾ã€‚
    frameit: å¿«é€Ÿåœ°æŠŠåº”ç”¨æˆªå›¾æ”¾å…¥è®¾å¤‡æ¡†é‡Œã€‚

* è‡ªåŠ¨åŒ–ç¼–è¯‘å·¥å…·

    gym: ç¼–è¯‘ã€æ‰“åŒ…iOS app,ç”Ÿæˆç­¾åçš„ipaæ–‡ä»¶ ã€‚

* App å…¬æµ‹å·¥å…·

    pilotï¼šç®¡ç†TestFlightæµ‹è¯•ç”¨æˆ·ï¼Œä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
    firimï¼šç®¡ç†firimã€‚


å®‰è£…fastlane
----

å®‰è£…æœ€æ–°çš„Xcodeå‘½ä»¤è¡Œå·¥å…·ï¼š

```
xcode-select --install
```

ä½¿ç”¨å®‰è£…fastlane

```
# ä¸¤è€…äºŒé€‰ä¸€
# Using RubyGems
sudo gem install fastlane -NV

# Alternatively using Homebrew
brew cask install fastlane
```

è®¾ç½®fastlane
----

ä½¿ç”¨fastLaneçš„æœ‰äº›ä¸œè¥¿éœ€è¦å°†è¿è¡Œçš„schemeè®¾ç½®æˆshared.

* æ‰“å¼€Xcodeé¡¹ç›®
* é€‰æ‹©Product > Scheme > Manage Schemes
* å°†å¯¹åº”çš„schemeå‹¾é€‰ä¸ŠShared

ä¸ºäº†åé¢å¯èƒ½ä¼šä½¿ç”¨è„šæœ¬ä¿®æ”¹ç‰ˆæœ¬å·ï¼Œæå‰è®¾ç½®ï¼š

* é€‰æ‹©é¡¹ç›®->target->build settings, æœç´¢versioning
* é€‰æ‹©Current Project Versionï¼Œä¿®æ”¹ä¸ºå½“å‰ç‰ˆæœ¬å·
* é€‰æ‹©Versioning System,ä¿®æ”¹Noneä¸ºApple Generic

æ‰“å¼€å‘½ä»¤è¡Œ`cd`åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼Œè¿›è¡Œåˆå§‹åŒ–

```
# é¦–å…ˆæ‰§è¡Œfastlane initå‘½ä»¤ï¼Œåœ¨Appfileå¡«å……ä¿¡æ¯
[sudo] fastlane init
```

åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šå‡ºç°ä¸‹é¢çš„é€‰é¡¹ï¼šå¯ä»¥é€‰æ‹©4æ‰‹åŠ¨è®¾ç½®. å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬çš„å·¥ç¨‹ä¼šå‡ºç°fastlaneæ–‡ä»¶å¤¹
![å›¾ç‰‡](http://47.75.49.0:8080/wp-content/uploads/2019/03/WX20190304-104345.png)

    ç¬¬ä¸€ä¸ªé€‰é¡¹çš„æ„æ€æ˜¯ï¼šè‡ªåŠ¨æˆªå±ã€‚è¿™ä¸ªåŠŸèƒ½èƒ½å¸®æˆ‘ä»¬è‡ªåŠ¨æˆªå–APPä¸­çš„æˆªå›¾ï¼Œå¹¶æ·»åŠ æ‰‹æœºè¾¹æ¡†ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ ç¬¬äºŒä¸ªé€‰é¡¹çš„æ„æ€æ˜¯ï¼šè‡ªåŠ¨å‘å¸ƒbetaç‰ˆæœ¬ç”¨äºTestFlight 
    ç¬¬ä¸‰ä¸ªé€‰é¡¹çš„æ„æ€æ˜¯ï¼šè‡ªåŠ¨å‘å¸ƒåˆ°AppStore 
    ç¬¬å››ä¸ªé€‰é¡¹çš„æ„æ€æ˜¯ï¼šæ‰‹åŠ¨è®¾ç½®

Appfileå­˜å‚¨Appä¿¡æ¯ï¼Œæ¯”å¦‚Apple IDï¼Œbundle IDç­‰ä¿¡æ¯,å¡«å†™Appfileè´¦æˆ·ä¿¡æ¯

    app_identifier("cn.xxxxx.me") # åº”ç”¨çš„bundle identifier
    apple_id "xxxxx@gmail.com"  # è‹¹æœè´¦å·çš„ID
    apple_dev_portal_id "xxxxx@gmail.com" # å¼€å‘è€…è´¦å·çš„ç”¨æˆ·å
    # itunes_connect_id "bhlin790@gmail.com" # è‹¹æœå•†åº—ITunes connectçš„è´¦å·
    # team_id "2293673LMU" # Developer Portal Team ID
    # itc_team_id "1454345822" # App Store Connect Team ID

é€šè¿‡Matchç®¡ç†è¯ä¹¦ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆ›å»ºMatchfileæ–‡ä»¶
    
```
# å¦‚æœæœªå‡ºç°Matchfileæ–‡ä»¶ï¼Œ ä½œç”¨: ç®¡ç†è¯ä¹¦ï¼Œ ä½¿ç”¨ä»¥ä¸‹æ–¹å¼åˆ›å»º
fastlane match init
```

    # gitä»“åº“åœ°å€
    git_url("http://xxxxx/xxxx/iOSCertificate")
    # å®šä¹‰è¦å­˜å‚¨è¯ä¹¦çš„ä½ç½®
    storage_mode("git")
    # åº”ç”¨çš„æ†ç»‘æ ‡è¯†ç¬¦ï¼ˆä»¥é€—å·åˆ†éš”ï¼‰
    app_identifier(["cn.xxxxx.me"])
    # Apple IDç”¨æˆ·å
    username("xxxxxx@gmail.com")
    # ç‰¹å®šçš„gitåˆ†æ”¯
    git_branch("master")


Deliverå°†æˆªå›¾ï¼Œå…ƒæ•°æ®å’ŒäºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä¼ åˆ°App Store Connect,åˆ›å»ºDeliverfileæ–‡ä»¶

```
# å¦‚æœæœªå‡ºç°Deliverfileæ–‡ä»¶, ä½œç”¨ï¼šä¸Šä¼ äºŒè¿›åˆ¶æ•°æ®å’Œå…ƒæ•°æ®å’Œå›¾ç‰‡ï¼Œä½¿ç”¨ä»¥ä¸‹æ–¹å¼åˆ›å»º
[sudo] fastlane deliver init
```
    
    app_identifier("cn.lindev.me")

    username("bhlin790@gmail.com")
    
    platform("ios")
    # ä¿®æ”¹å®æ—¶å…ƒæ•°æ®ï¼Œæ­¤é€‰é¡¹ç¦ç”¨ipaä¸Šä¼ å’Œå±å¹•æˆªå›¾ä¸Šä¼ 
    # edit_liveï¼ˆtrueï¼‰
    force(true)
    #ä¸è¦ä¸Šä¼ å…ƒæ•°æ®ï¼ˆä¾‹å¦‚æ ‡é¢˜ï¼Œè¯´æ˜ï¼‰ã€‚è¿™ä»ç„¶ä¼šä¸Šä¼ æˆªå›¾
    # skip_metadata(true)
    #ä¸è¦ä¸Šä¼ æˆªå›¾
    skip_screenshots(true)



ä¸Šé¢æ“ä½œç»“æŸåï¼Œæ ¹ç›®å½•ä¼šæœ‰ä¸€ä¸ªGemfileæ–‡ä»¶ï¼š

1\. æ‰“å¼€æ–‡ä»¶å¦‚æœGemfileæ–‡ä»¶æœ‰å†…å®¹å°±ä¸éœ€è¦æ·»åŠ ï¼Œæ²¡æœ‰åˆ™æ·»åŠ ä»¥ä¸‹å†…å®¹

```
source "https://rubygems.org"
gem "fastlane"
```

2\. æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

```
# å®‰è£…bundler
sudo gem install bundler

# æ›´æ–° bundleï¼ŒæˆåŠŸä¹‹åä¼šç”Ÿæˆä¸€ä¸ªç‰ˆæœ¬æ§åˆ¶çš„Gemfile.lockæ–‡ä»¶
[sudo] bundle update
```

3\. æ‰§è¡Œå‘½ä»¤ï¼šbundle exec fastlane [lane_name]ï¼Œæ‰§è¡Œlane_nameè„šæœ¬ã€‚è¿™é‡Œçš„lane_nameæ˜¯è„šæœ¬çš„åç§°ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºå‡½æ•°åï¼Œå¦‚æœæˆ‘ä»¬åªæ‰§è¡Œbundle exec fastlaneå‘½ä»¤ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªè®©æˆ‘ä»¬é€‰æ‹©çš„åœ°æ–¹ï¼Œé€‰æ‹©éœ€è¦æ‰§è¡Œçš„è„šæœ¬ã€‚

#### è¿›é˜¶

å¦‚æœåªæ˜¯å¾ˆç®€å•çš„ä¸Šä¼ åˆ°iTunes connectï¼Œä¸Šé¢çš„æ“ä½œå°±å¯ä»¥æ»¡è¶³ã€‚

å¦‚æœæˆ‘ä»¬æ˜¯å¤šä¸ªtargetæˆ–è€…éœ€è¦é…ç½®ä¸€äº›ITCä¸Šé¢çš„å†…å®¹ï¼Œåˆ™éœ€è¦è¿›ä¸€æ­¥çš„æ·±å…¥ã€‚

##### metadata

metadataæ˜¯åŒ…å«åº”ç”¨åœ¨ITCä¸Šé¢çš„å„ç§ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨å®ƒé…ç½®æˆ‘ä»¬çš„ITCï¼Œå»ºè®®ä½¿ç”¨Deliverfileã€‚

##### screenshots

å±å¹•æˆªå›¾æ•°æ®ã€‚

##### Appfile

å­˜å‚¨Appä¿¡æ¯ï¼Œæ¯”å¦‚Apple IDï¼Œbundle IDç­‰ä¿¡æ¯ã€‚

##### Deliverfile

äº¤ä»˜æ–‡ä»¶ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢å¯ä»¥è®¾ç½®iTunes connectçš„æ‰€æœ‰é…ç½®é¡¹ï¼Œä¾‹å¦‚ï¼š

* release_notesï¼Œæ­¤ç‰ˆæœ¬æ–°å¢å†…å®¹ã€‚
* copyrightï¼Œç‰ˆæƒä¿¡æ¯ã€‚
* submit_for_reviewï¼Œä¸Šä¼ å®Œæˆåæ˜¯å¦ç›´æ¥æäº¤æ–°ç‰ˆæœ¬è¿›è¡Œå®¡æŸ¥ã€‚
* forceï¼Œè·³è¿‡HTMLæŠ¥å‘Šæ–‡ä»¶éªŒè¯ã€‚
* ...

##### Fastfile
è‡ªåŠ¨åŒ–è„šæœ¬é…ç½®æ–‡ä»¶ã€‚ æ˜¯æˆ‘ä»¬è„šæœ¬çš„å…¥å£ï¼Œæ‰€æœ‰çš„äº‹ä»¶é©±åŠ¨éƒ½æ˜¯åœ¨è¿™ä¸ªæ–‡ä»¶æ¥è°ƒåº¦çš„ã€‚

```
default_platform(:ios)

platform :ios do

	desc "æè¿°ä¿¡æ¯"
	lane : Archive_TargetA do |options|
		scheme = options[:scheme]
		date = Time.new.strftime("%Y%m%d-%h%M")
		
		# export_method æ”¯æŒ app-store, ad-hoc, package, enterprise, development
		gym(
			scheme: "#{scheme}",
			output_name: "#{scheme}-#{date}.ipa",
			clean: true,
			export_method: 'app-store',
		)

		# upload_to_app_store
		deliver # å½“deliverfileä¸ºç©ºçš„æ—¶å€™ï¼ŒåŒ upload_to_app_store ä½œç”¨ä¸€æ ·
	end
end
```

cdåˆ°é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œå‘½ä»¤ï¼š`bundle exec fastlane Archive_TargetA scheme:"CDDemo"`ï¼Œåé¢çš„`scheme`æ˜¯å¸¦çš„å‚æ•°ã€‚

##### Multi-Target

æœæˆ‘ä»¬éœ€è¦é…ç½®å¤šä¸ªtargetè¿›è¡Œæ‰“åŒ…çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œæ¥è¿›è¡Œé…ç½®ã€‚å‡å¦‚æˆ‘ä»¬ç°åœ¨æœ‰ä¸¤ä¸ªtargetï¼ŒtargetA å’Œ targetBï¼Œåˆ™æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸¤ä¸ª.envæ–‡ä»¶ï¼Œä¾‹å¦‚.env.targetA,.env.targetBï¼Œæ”¾åœ¨Fastfileæ–‡ä»¶åŒçº§ç›®å½•ä¸‹
![](http://47.75.49.0:8080/wp-content/uploads/2019/03/WX20190227-131729.png)

åœ¨.envæ–‡ä»¶é‡Œé¢æˆ‘ä»¬å¯ä»¥é…ç½®ä¸€äº›ä¸åŒçš„å†…å®¹ï¼ˆéå…¬å…±ï¼‰ï¼Œæ¯”å¦‚app_identifierï¼Œrelease_notesç­‰ç­‰ã€‚æˆªå›¾å¦‚ä¸‹ï¼š
![](http://47.75.49.0:8080/wp-content/uploads/2019/03/WX20190227-131759.png)

åœ¨Appfileï¼ŒDeliverfileï¼ŒFastfileç­‰æ–‡ä»¶ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨.envæ–‡ä»¶é‡Œé¢çš„å†…å®¹ã€‚

1\. Appfile

```
# Appfile

#The bundle identifier of your app
app_identifier ENV['APP_IDENTIFIER']

# Your Apple email address
apple_id ENV['APPLE_ID'] 

# Developer Portal Team ID
team_id ENV['TEAM_ID']
```

2\. Deliverfileï¼Œè¯·åœ¨è®¾ç½®release_noresã€support_urlã€private_urlç­‰é…ç½®çš„æ—¶å€™ï¼Œé‡‡ç”¨hashçš„æ–¹å¼å†™ã€‚

```
# app_identifier
app_identifier ENV['APP_IDENTIFIER']

# ç”¨æˆ·å,Apple IDç”µå­é‚®ä»¶åœ°å€
username ENV['APPLE_ID']

# å›¢é˜ŸID
team_id ENV['TEAM_ID']

# å›¢é˜Ÿname
team_name ENV['TEAM_NAME']

# copyright
copyright ENV['COPYRIGHT']

# å…³é”®å­—
keywords(
	'zh-Hans' => ENV['KEYWORDS'],
)

# æ–°ç‰ˆæœ¬ä¿®æ”¹è®°å½•
release_notes(
	# ä¸­å›½
	'zh-Hans' => ENV['RELEASE_NOTES'],
	# æ¾³å¤§åˆ©äºš
	'en-au' => ENV['RELEASE_NOTES_AU'],
	# ç¾å›½
	'en-us' => ENV['RELEASE_NOTES_US']
)

# æ”¯æŒç½‘å€
support_url(
	# ä¸­å›½
	'zh-Hans' => ENV['SUPPORT_URL'],
	# æ¾³å¤§åˆ©äºš
	'en-au' => ENV['SUPPORT_URL_AU'],
	# ç¾å›½
	'en-us' => ENV['SUPPORT_URL_US']
)

# éšç§æ”¿ç­–ç½‘å€ å›½å®¶ä»£ç  https://www.cnblogs.com/Mien/archive/2008/08/22/1273950.html
privacy_url(
	# ä¸­å›½
	'zh-Hans' => ENV['PRIVACY_URL'],
	# æ¾³å¤§åˆ©äºš
	'en-au' => ENV['PRIVACY_URL_AU'],
	# ç¾å›½
	'en-us' => ENV['PRIVACY_URL_US']
)

# ä¸Šä¼ å®Œæˆåæäº¤æ–°ç‰ˆæœ¬è¿›è¡Œå®¡æŸ¥
submit_for_review false

# è·³è¿‡HTMLæŠ¥å‘Šæ–‡ä»¶éªŒè¯
force true

# å¯ç”¨iTCçš„åˆ†é˜¶æ®µå‘å¸ƒåŠŸèƒ½ ç°åº¦å‘å¸ƒ
phased_release true

# åº”ç”¨å®¡æ ¸å°ç»„çš„è”ç³»ä¿¡æ¯ app å®¡æ ¸ä¿¡æ¯
app_review_information(
  first_name: "xx",
  last_name: "xx",
  phone_number: "+86 18888888888",
  email_address: "xxxx",
  demo_user: "test1@test.com",
  demo_password: "test123"
)

...
```

3\. Fastfileæ–‡ä»¶é‡Œé¢ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œè·Ÿä¸Šé¢ç•¥æœ‰ä¸åŒã€‚åœ¨Fastfileé‡Œé¢ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰lane è¦ä½¿ç”¨é‚£ä¸ª.envæ–‡ä»¶ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦ä½¿ç”¨shè„šæœ¬å‘½ä»¤çš„å½¢å¼æ¥è°ƒç”¨ä¸€ä¸ªlane åé¢è·Ÿä¸Š--env ç¯å¢ƒå˜é‡æ–‡ä»¶åï¼Œæ­¤æ—¶è°ƒç”¨çš„lane ä¸èƒ½å£°æ˜ä¸ºprivate_laneï¼Œè°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```
lane :releaseDemo2 do
	# æ— å‚æ•°
	sh "fastlane Archive_TargetA --env TargetA"
	
	# æœ‰å‚æ•°
	sh 'fastlane Archive_TargetA type:\'å“ˆå“ˆå“ˆå“ˆ\' --env TargetA'
end


å¤–éƒ¨ç›´æ¥è°ƒç”¨ï¼ˆå¸¦å‚æ•°ï¼‰
bundle exec fastlane Archive_TargetA type:"haha" --env TargetA
```

4\. laneä¹‹é—´çš„è°ƒç”¨

è·Ÿæˆ‘ä»¬è‡ªå·±å†™æ–¹æ³•è°ƒç”¨ä¸€æ ·ï¼Œä¾‹å¦‚ï¼š

```
desc "æ‰“åŒ…ç»Ÿä¸€å…¥å£"
lane :Archive do |options|
	# å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°'type'æ˜¯targetAï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ‰§è¡ŒArchive_TargetA è¿™ä¸ªlaneã€‚ã€‚ã€‚
	type = options[:type]
  	if type == "TargetA"
    	Archive_TargetA(options)
  	elsif type == "TargetB"
        Archive_TargetB(options)
	else
    	Archive_TargetA(options)
  	end
end
```

5\. ç³»ç»Ÿçº§lane

fastlane é»˜è®¤æœ‰ laneã€‚

* before_allï¼Œå°±æ˜¯åœ¨æ‰§è¡Œä¸€æ¬¡è„šæœ¬ä¹‹å‰é¦–å…ˆæ‰§è¡Œçš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œé¢æ‰§è¡Œä¸€äº›å…¬å…±çš„ä¸œè¥¿ï¼Œæ¯”å¦‚git_pullï¼Œcocoapodsã€‚

```
before_all do
  # æ£€å‡ºåˆ° Developer åˆ†æ”¯
  sh 'git checkout Developer'
  git_pull
  cocoapods(repo_update: true)
end
```

* after_allï¼Œ æˆåŠŸç»“æŸä¹‹åï¼Œå¤„ç†å…±æœ‰çš„åç½®é€»è¾‘ã€‚
* before_eachï¼Œæ¯æ¬¡æ‰§è¡Œ lane ä¹‹å‰éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚
* after_eachï¼Œæ¯æ¬¡æ‰§è¡Œ lane ä¹‹åéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚
* errorï¼Œåœ¨æ‰§è¡Œä¸Šè¿°æƒ…å†µä»»æ„ç¯å¢ƒæŠ¥é”™éƒ½ä¼šä¸­æ­¢å¹¶æ‰§è¡Œä¸€æ¬¡ã€‚

6\. æ‰§è¡Œé¡ºåº
![](http://47.75.49.0:8080/wp-content/uploads/2019/03/WX20190227-133123.png)


### Fastlaneå·¥å…·Matchçš„ä½¿ç”¨
å‡†å¤‡å·¥ä½œï¼š

    1\. åˆ›å»ºä¸€ä¸ªæ–°çš„ç§æœ‰Gitä»“åº“
    2\. å¯é€‰ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å…±äº«Apple Developer Portalå¸æˆ·ï¼Œoffice@company.comæ­¤ç±»å¸æˆ·å°†ä»ç°åœ¨å¼€å§‹åœ¨æ‚¨çš„å›¢é˜Ÿä¸­å…±äº«
    3\. åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å¼€å§‹ä½¿ç”¨match

```
fastlane match init
```
åˆ›å»ºåœ¨æ‚¨å½“å‰çš„ç›®å½•ï¼ˆæˆ–æ‚¨çš„fastlane/æ–‡ä»¶å¤¹ï¼‰ä¸­åˆ›å»ºä¸€ä¸ªMatchfileæ–‡ä»¶, æ›´å¤šé«˜çº§æŸ¥çœ‹[fastlaneéƒ¨åˆ†](https://docs.fastlane.tools/actions/match/#fastlane)

```
# gitä»“åº“åœ°å€
git_url("http://xxxxx/xxxx/iOSCertificate")
# å®šä¹‰è¦å­˜å‚¨è¯ä¹¦çš„ä½ç½®
storage_mode("git")
# åº”ç”¨çš„æ†ç»‘æ ‡è¯†ç¬¦ï¼ˆä»¥é€—å·åˆ†éš”ï¼‰
app_identifier(["cn.xxxxx.me"])
# Apple IDç”¨æˆ·å
username("xxxxxx@gmail.com")
# ç‰¹å®šçš„gitåˆ†æ”¯
git_branch("master")
```

ä½¿ç”¨å½“å‰æœºå™¨åˆ›å»ºè¯ä¹¦ï¼Œè¿è¡Œ`fastlane match init`åï¼Œæ‚¨å¯ä»¥è¿è¡Œä¸€ä¸‹å‘½ä»¤åˆ›å»ºæ–°çš„è¯ä¹¦å’Œé…ç½®æ–‡ä»¶

```
# åˆ›å»ºæµ‹è¯•ç¯å¢ƒè¯ä¹¦ï¼Œæ ¹æ®Matchfileæ–‡ä»¶ä¸­çš„app_identifieråˆ›å»ºä¸€ä¸ªdevelopmentè¯ä¹¦ï¼Œå­˜åœ¨Gitä»“åº“ä¸­ï¼Œå¹¶ä¸‹è½½å½“å‰æœ¬åœ°ç¯å¢ƒæ±‡æ€»
fastlane match development
# åˆ›å»ºå‘å¸ƒç¯å¢ƒè¯ä¹¦
fastlane match appstore
```

ä½¿ç”¨Matchè‡ªåŠ¨é€‰æ‹©è¯ä¹¦ï¼Œé¦–é¡µåœ¨é¡¹ç›®ä¸­æ ¹æ®ä¸åŒæ¢å°†é€‰æ‹©ä¸åŒçš„è¯ä¹¦[å›¾ç‰‡]()

```
# æ›´æ–°æœ¬åœ°å‘å¸ƒè¯ä¹¦ç¯å¢ƒ
match(type: "appstore")
# æ›´æ–°æœ¬åœ°å¼€å‘è¯ä¹¦ç¯å¢ƒ
match(type: "development")
```

å…·ä½“è®¾ç½®æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://docs.fastlane.tools/actions/match/)

fastlaneæä¾›çš„ä¸¤æ­¥éªŒè¯è§£å†³æ–¹æ¡ˆ[åšå®¢](https://xilankong.github.io/2017%E5%B9%B4/2017/07/05/fastlane%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E%E4%B9%A6.html)

```
1.è®¿é—® https://appleid.apple.com/account/manage 
2.ç”Ÿæˆä¸€ä¸ª APP-SPECIFIC PASSWORDSï¼Œä¿ç•™ç”Ÿæˆçš„ç‰¹æ®Šå¯†ç 
3.ä½¿ç”¨ç¯å¢ƒå˜é‡æä¾›è¿™ä¸ªå¯†ç ç»™fastlaneï¼š  FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD
4.æ‰§è¡Œfastlane spaceauth -u user@email.comï¼Œç”Ÿæˆsession cookieã€‚
5.é€šè¿‡ç¯å¢ƒå˜é‡FASTLANE_SESSION æä¾›session cookiesã€‚

é…ç½®åœ°æ–¹ï¼š

æ‰“åŒ…æœºï¼š~/.bash_profile ä¸­ï¼Œé…ç½® FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD å’Œ FASTLANE_SESSION

ä¾‹å¦‚ï¼š
export FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD=ç‰¹æ®Šå¯†ç 
export FASTLANE_SESSION=session cookie

æœ¬æœºä½¿ç”¨çš„æ˜¯Item2 /bin/zsh æ‰€ä»¥é…ç½®åœ¨ ~/.bash_profile
Jenkinsï¼šé…ç½®å¯¹åº”ç¯å¢ƒå˜é‡å³å¯

è¿˜æœ‰ä¸€ä¸ªå°ä¼™ä¼´å‘ŠçŸ¥å¦ä¸€ä¸ªé…ç½®æ–¹å¼
ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] = "xxxxxx"
è¿™ä¸ªå’Œç¯å¢ƒå˜é‡é…ç½®æ˜¯ä¸€ä¸ªæ„æ€ï¼Œä½†æ˜¯æ¶‰åŠå¯†ç å†™åœ¨é…ç½®æ–‡ä»¶é‡Œé¢

ä½†æ˜¯ï¼Œæœ¬æ–‡æµ‹è¯•ä¸€ä¸ªæœˆåå‘ç°ä¾ç„¶å¤±æ•ˆï¼Œæœ€åé€‰æ‹©çš„æ–¹æ¡ˆæ˜¯å¼€è®¾ä¸€ä¸ªæœªå¼€å¯ä¸¤æ­¥éªŒè¯çš„è´¦å·ä½œä¸ºå¼€å‘è´¦å·çš„å­è´¦å·ä¸“é—¨ç”¨æ¥æ‰“åŒ…ã€‚
å¦‚æœ‰ä¸è¿‡æœŸæ–¹å¼ï¼Œæ¬¢è¿è¡¥å……

```




### é”™è¯¯é›†åˆ

æŠ¥é”™Exit status of command 'bundle exec pod install' was 1 instead of 0. bundler: failed to load command: pod (/usr/local/bin/pod)

> è§£å†³æ–¹æ³•ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ fastlane/Fastfile ä¿®æ”¹æ–‡ä»¶ä¸­çš„cocoapods
'  cocoapods(use_bundle_exec: false)'

è‡ªåŠ¨åŒ–ç‰ˆæœ¬å’Œå†…éƒ¨ç‰ˆæœ¬å·æŠ¥é”™,increment_build_numberæŠ¥é”™

> è§£å†³æ–¹æ³•ï¼šåœ¨buidl settings ä¸­ä¿®æ”¹Current Project Versionçš„å€¼ä¸º1ï¼ŒVersioning Systemçš„å€¼ä¸ºApple Genericã€‚[å‚è€ƒç­”æ¡ˆ](https://developer.apple.com/library/archive/qa/qa1827/_index.html)

æŠ¥é”™Permission denied @ rb_sysopen - ./fastlane/README.md

> æƒé™é—®é¢˜ï¼Œæ‰“åŒ…æˆåŠŸäº†ï¼Œå…·ä½“åŸå› åœ¨æ’æŸ¥ï¼Œå¯èƒ½è¦ä¿®æ”¹ç³»ç»Ÿçš„æŸäº›ä¸œè¥¿

æœ‰äº›æ–‡ä»¶å­˜åœ¨æƒé™é—®é¢˜,ä¾‹å¦‚ï¼šchmod: Unable to change file mode on cookie: Operation not permitted.
> chmod u+rw æ–‡ä»¶å
> å¦‚æœä¸è¡Œ sudo chmod u+rw

gitlab-ciçš„runnerä¸ruby(rvmè½¯ä»¶)å†²çªï¼Œå¯ä»¥é‡è®¾cdè§£å†³ã€‚ [gitlabå¸–å­](https://gitlab.com/gitlab-org/gitlab-runner/issues/114#note_4399113)
> è§£å†³æ–¹æ¡ˆï¼šåœ¨`~/.bash_profile`è¾“å…¥unset cd 


pod repo update ~/.cocoapods/repos/***/ éœ€è¦æ›´æ–°å“ªä¸ªå°±æŒ‡å®šå“ªä¸ªæ–‡ä»¶å¤¹å°±å¯ä»¥äº†

pod specä½¿ç”¨å›½å†…é•œåƒï¼šhttps://juejin.im/post/5afa542ff265da0b863665a6

githubè®¾ç½®ä»£ç†ï¼šhttps://gist.github.com/laispace/666dd7b27e9116faece6



### å‚è€ƒæ–‡æ¡£
> [ä½¿ç”¨GitLabæ¥å®ç°IOSé¡¹ç›®çš„æŒç»­é›†æˆCI - ç®€ä¹¦](https://www.jianshu.com/p/c840632cef38)
> [ä¸‹è½½gitlabe runner](https://docs.gitlab.com/runner/install/)
> [gitlab-cié…ç½®è¯¦è§£(ä¸€)](https://segmentfault.com/a/1190000011881435)
> [gitlab-cié…ç½®è¯¦è§£(äºŒ)](https://segmentfault.com/a/1190000011890710)
> [GitLab CI/CD Variables ä¸­æ–‡æ–‡æ¡£](http://www.ttlsa.com/auto/gitlab-cicd-variables-zh-document/)
> [fastlane docs](https://docs.fastlane.tools/)
> [iOS æŒç»­äº¤ä»˜ä¹‹ Fastlane - æ˜é‡‘](https://juejin.im/post/5a7b10bb6fb9a0636263bfd5)
> [iOSä¸­fastlaneçš„ä½¿ç”¨](https://blog.devzeng.com/blog/ios-fastlane-in-action.html)
> [Fastlaneä½¿ç”¨æ€»ç»“(ä¸€) - ç®€ä¹¦](https://www.jianshu.com/p/04b83b335d53)
> [Fastlaneä½¿ç”¨æ€»ç»“(äºŒ) - ç®€ä¹¦](https://www.jianshu.com/p/f96f16dac276)


